---
title: "Pathway Analysis: AUCell"
output:
  html_notebook:
    toc: true
    toc_float: true
author: CCDL for ALSF
date: 2024
---

## Objectives



---

https://bioconductor.org/packages/release/bioc/vignettes/AUCell/inst/doc/AUCell.html

## Set up

### Libraries

```{r libraries}
# We will
suppressPackageStartupMessages({
  library(SingleCellExperiment)
})

# Gene sets
library(AUCell)
library(GSEABase)
library(msigdbr)
```
### Directories and files

#### Directories

```{r setup_directories}

```

#### Files

```{r setup_files}
sce_file <- "data/ewing-sarcoma/processed/SCPCS000490/SCPCL000822_processed.rds"
```

### Functions

```{r source_functions}

```


## Set up gene sets

We are going to use two gene sets pertaining to Ewing Sarcoma.


```{r genesets}
ewing_gene_set_names <- c("ZHANG_TARGETS_OF_EWSR1_FLI1_FUSION",
                          "RIGGI_EWING_SARCOMA_PROGENITOR_UP")
```

These gene sets come from the C2 gene set collection from MSigDB.
Let's retrieve them using `msigdbr()`.

```{r extract_genesets, live = TRUE}
ewing_gene_sets_df <- msigdbr(species = "Homo sapiens",
                              category = "C2",
                              subcategory = "CGP") |>
  dplyr::filter(gs_name %in% ewing_gene_set_names)
```

`AUCell` uses gene sets in a particular format that comes from the `GSEABase` package.
We need to create a `GeneSetCollection`.

```{r}
ewing_gene_set_collection <- ewing_gene_set_names |>
  purrr::map(
    \(gene_set_name) ewing_gene_sets_df |>
      dplyr::filter(gs_name == gene_set_name) |>
      dplyr::pull(ensembl_gene) |>
      GeneSet(setName = gene_set_name,
              geneIdType = ENSEMBLIdentifier())
  ) |>
  GeneSetCollection()
```


## Read in and prepare SingleCellExperiment

```{r read_in_sce, live = TRUE}
sce <- readr::read_rds(sce_file)
```

The `AUCell` functions takes an expression matrix with genes as rows and cells as column.
We can save a counts matrix in sparse format for use with `AUCell`.

```{r sparse_matrix}
# Extract counts matrix and save in sparse format
counts_matrix <- counts(sce) |>
  as("dgCMatrix")
```

There may be genes in our gene set that do not appear in the SingleCellExperiment object.
We can remove them using the `subsetGeneSets()` function.

```{r subset_gene_sets, live = TRUE}
# Remove genes from gene sets if they are not in the SCE
ewing_gene_set_collection <- subsetGeneSets(ewing_gene_set_collection,
                                            rownames(counts_matrix))
```

## AUCell

```{r}
set.seed(2024)
cell_rankings <- AUCell_buildRankings(counts_matrix)
```

```{r}
plot_AUC(cell_rankings,
         ewing_gene_set_collection,
         gene_set_name = "ZHANG_TARGETS_OF_EWSR1_FLI1_FUSION",
         barcode = "CTGAGCGGTCTTTATC",
         top_threshold = 0.05) 
```
```{r}
plot_AUC(cell_rankings,
         ewing_gene_set_collection,
         gene_set_name = "ZHANG_TARGETS_OF_EWSR1_FLI1_FUSION",
         barcode = "AGATAGAGTCACAATC",
         top_threshold = 0.05) 
```


```{r}
cell_auc <- AUCell_calcAUC(ewing_gene_set_collection, cell_rankings)

```

```{r}


```


```{r}
auc_assignments <- AUCell_exploreThresholds(cell_auc, 
                                            plotHist = FALSE, 
                                            assignCells = TRUE)
```

```{r}
auc_df <- cell_auc@assays@data$AUC |> 
  as.data.frame() |>
  tibble::rownames_to_column("geneset") |>
  tidyr::pivot_longer(!geneset, 
                      names_to = "barcodes",
                      values_to = "auc") |>
  dplyr::select(barcodes, geneset, auc) |>
  dplyr::mutate(
    assigned = dplyr::case_when(
      geneset == ewing_gene_set_names[1] & barcodes %in% auc_assignments[[ewing_gene_set_names[1]]]$assignment ~ TRUE,
      geneset == ewing_gene_set_names[2] & barcodes %in% auc_assignments[[ewing_gene_set_names[2]]]$assignment ~ TRUE,
      .default = FALSE
    )
  )
```

```{r}
auc_threshold_df <- data.frame(
  geneset = ewing_gene_set_names,
  threshold = c(auc_assignments[[ewing_gene_set_names[1]]]$aucThr$selected, 
                auc_assignments[[ewing_gene_set_names[2]]]$aucThr$selected)
)

auc_df |>
  ggplot2::ggplot(
    ggplot2::aes(
      x = auc,
      color = assigned,
      fill = assigned,
    )
  ) +
  ggplot2::geom_density(alpha = 0.2) +
  ggplot2::geom_vline(data = auc_threshold_df,
                      mapping = ggplot2::aes(xintercept = threshold),
                      lty = 2) +
  ggplot2::facet_grid(cols = ggplot2::vars(geneset)) +
  ggplot2::theme_bw()
```

```{r}
auc_coldata_df <- cell_auc@assays@data$AUC |>
  t() |>
  as.data.frame() |>
  tibble::rownames_to_column("barcodes") |>
  dplyr::rename(zhang_auc = ewing_gene_set_names[1],
                riggi_auc = ewing_gene_set_names[2])
```


```{r}
coldata_df <- colData(sce) |>
  as.data.frame() |>
  dplyr::left_join(
    auc_coldata_df,
    by = "barcodes"
  )

colData(sce) <- DataFrame(
  coldata_df,
  row.names = colData(sce)$barcodes
)
```

```{r}
scater::plotUMAP(sce, colour_by = "zhang_auc")
```

```{r}
scater::plotUMAP(sce, colour_by = "riggi_auc")
```

