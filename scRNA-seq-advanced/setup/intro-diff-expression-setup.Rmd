---
title: "Setup: Differential Expression Module"
author: "Ally Hawkins for the Data Lab"
date: "`r Sys.Date()`"
output: 
  html_notebook:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: false
---


## Setup and some initial exploration

Load already integrated data object. 
Should have cell type and any metadata (disease type already in the metadata)


```{r}
set.seed(2022)

library(magrittr)
library(SingleCellExperiment)
library(ggplot2)
library(edgeR)
```


```{r}
data_dir <- file.path("rhabdomyosarcoma")

scpca_library_ids <- c(
  "SCPCL000495",
  "SCPCL000498",
  "SCPCL000478",
  "SCPCL000479",
  "SCPCL000480",
  "SCPCL000483",
  "SCPCL000484",
  "SCPCL000488"
)

filtered_file_names <- paste0(scpca_library_ids, "_filtered.rds")
```

Individual files are available on s3 in s3://scpca-portal-inputs/SCPCP000005
```{r}
# read in rds files and create sce list 
filtered_file_paths <- file.path(data_dir, "filtered_scpca", filtered_file_names)

sce_list <- purrr::map(filtered_file_paths, readr::read_rds)
names(sce_list) <- scpca_library_ids
```

```{r}
## let's start with the integrated dataset first and then go back and deal with how we made it since a lot of what goes into creating the dataset for integration we can apply here too so we might want to reuse code 
```

```{r}
combined_sce_file <- file.path(data_dir, "merged_sce", "SCPCP000005_merged_sce.rds")
combined_sce <- readr::read_rds(combined_sce_file)


integrated_sce_file <- file.path(data_dir, "integrated_sce", "SCPCP000005_integrated_fastmnn_sce.rds")
integrated_sce <- readr::read_rds(integrated_sce_file)
```

```{r}
# put the integrated PCA and UMAP into the combined object so all the data is together 
reducedDim(combined_sce, "fastmnn_PCA") <- reducedDim(integrated_sce, "fastmnn_PCA")
reducedDim(combined_sce, "fastmnn_UMAP") <- reducedDim(integrated_sce, "fastmnn_UMAP")
reducedDimNames(combined_sce)
```

```{r}
# read in sample level metadata to use for DE 
# is this something we would want to show? 
sample_metadata <- readr::read_tsv(file.path(data_dir, "rms_sample_metadata.tsv"))
```

```{r}
# collapse cell types 
coldata_df <- colData(combined_sce) %>%
  as.data.frame() %>%
  dplyr::mutate(sub_celltype = celltype,
                # remove any of the subtypes to create new cell type column 
                celltype = stringr::str_remove(sub_celltype, "-[ABCD]")) %>%
  # merge with sample metadata 
  dplyr::left_join(sample_metadata, by = c("batch" = "library_id"))

# add back to sce 
colData(combined_sce) <- DataFrame(coldata_df, row.names = rownames(coldata_df))
```


```{r}
# UMAP to show cell type and integration  
scater::plotReducedDim(combined_sce,
                       dimred = "fastmnn_UMAP",
                       colour_by = "batch",
                       point_size= 0.5,
                       point_alpha = 0.2)

```

```{r}
scater::plotReducedDim(combined_sce,
                       dimred = "fastmnn_UMAP",
                       colour_by = "celltype",
                       point_size= 0.5) + 
                       #point_alpha = 0.4) +
  facet_wrap(~ combined_sce$batch, nrow = 3)
```

Looking at this plot let's us know which cell types belong to which sample and can help us pick which libraries we might want to consider for differential expression.
From this we see that 6 of the libraries show a split between `Tumor_Mesoderm`, `Tumor_Myoblast` and `Tumor_Myocyte`.
3 libraries are mostly `Tumor` and they probably weren't able to be classified into sub types. 
Then 1 library has what appears to be all `NA`. 
Let's just look at the libraries that have myoblast, mesoderm, and myocytes and see if we can do some differential expression between those libraries. 

## Set up of dataset to use for integration

```{r}
# define libraries to keep
scpca_library_ids <- c(
  "SCPCL000479",
  "SCPCL000480",
  "SCPCL000481",
  "SCPCL000484",
  "SCPCL000488",
  "SCPCL000491"
)

# # subset sce to only contain batches with library IDs of interest 
cells_to_keep <- combined_sce$batch %in% scpca_library_ids
rms_sce <- combined_sce[,cells_to_keep]
```

Let's make some of the same plots above and show the distribution of cell types. 

```{r}
# UMAP to show cell type and integration  
scater::plotReducedDim(rms_sce,
                       dimred = "fastmnn_UMAP",
                       colour_by = "batch",
                       point_size= 0.5,
                       point_alpha = 0.2)
```

```{r}
scater::plotReducedDim(rms_sce,
                       dimred = "fastmnn_UMAP",
                       colour_by = "celltype",
                       point_size= 0.5) + 
                       #point_alpha = 0.4) +
  facet_wrap(~ rms_sce$batch)
```

```{r}
table(rms_sce$celltype)

# can also print out a summary of the cell types across each library 
colData(rms_sce) %>%
  as.data.frame() %>%
  dplyr::count(batch, celltype) %>%
  dplyr::group_split(batch)
```
Tumor_Myoblast is definitely the top represented cell type 

```{r}
# Let's look at some of the clinical metadata that we have 
table(rms_sce$diagnosis) # everything is RMS 
table(rms_sce$subdiagnosis) # sample is split between ERMS and ARMS 

# how many of each, 3 of each subdiagnosis, that's enough replicates so let's compare! 
colData(rms_sce) %>%
  as.data.frame() %>%
  dplyr::count(batch, subdiagnosis)
```

```{r}
# we also have some tissue location? and disease recurrence, what does that breakdown look like 
colData(rms_sce) %>%
  as.data.frame() %>%
  dplyr::count(batch, subdiagnosis, disease_timing, tissue_location)
```


## Differential Expression between conditions 

## Pseudobulking 

Some motivation behind why we want to use pseudobulking 
Let's start with the simple comparison of looking at one cell type and comparing across ERMS and ARMS subtypes. 

```{r}
# first let's subset our coldata to only have the columns we care about in pseudobulking 
pseudobulked_coldata <- colData(rms_sce)[, c("celltype", "batch")]

# this creates a new SCE object that contains the pseudobulked counts across the provided groups 
pseudobulked_sce <- scater::aggregateAcrossCells(rms_sce, 
                                                  id = pseudobulked_coldata)

pseudobulked_sce
```
```{r}
# only 37 columns in the counts assay 
counts(pseudobulked_sce)[1:10, ]
```

```{r}
# note the new addition of the column with number of cells per group 
colData(pseudobulked_sce)

```

Now we filter to just the sub type of cells that we are interested in 

```{r}
tumor_myoblast_sce <- pseudobulked_sce[, pseudobulked_sce$celltype == "Tumor_Myoblast"]
table(tumor_myoblast_sce$celltype)
```

We should now see that there are only 6 samples left that all have the cell type `Tumor_Myoblast`. 

```{r}
dge_list <- DGEList(counts(tumor_myoblast_sce),
                    samples = colData(tumor_myoblast_sce))
dge_list
```
Filter based on any low library counts. 

```{r}
# filter by number of cells 
low_cell_groups <- tumor_myoblast_sce$ncells < 10
tumor_myoblast_sce <- tumor_myoblast_sce[, !low_cell_groups]

# filter out genes that might be lowly expressed using filterbyExpr from DGE 

```

```{r}
# compute some normalization factors 
```

```{r}
# mean difference plots? 
```

```{r}
# MDS scaling plot 
```

Let's do some DE now! 

```{r}
# set up design matrix 
```


```{r}
# estimate dispersions 
```

```{r}

```

