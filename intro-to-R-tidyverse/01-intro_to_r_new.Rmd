---
title: "Intro to R"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

**CCDL 2020**

## Objective for this notebook analysis: 

We've [performed differential expression analyses](./scripts/00-setup-intro-to-R.R) on a pre-processed [astrocytoma microarray dataset](https://www.refine.bio/experiments/GSE44971/gene-expression-data-from-pilocytic-astrocytoma-tumour-samples-and-normal-cerebellum-controls).
We performed three sets of contrasts:  

1) `sex` category contrasting: Male vs Female  
2) `tissue` category contrasting : Pilocytic astrocytoma tumor samples vs normal cerebellum samples  
3) An interaction of both `sex` and `tissue`. 

*Resources for learning R* 

  - [Swirl, an interactive tutorial](https://swirlstats.com/)  
  - [R Markdown](http://rmarkdown.rstudio.com)
  - [R for Data Science](https://r4ds.had.co.nz/)  
  - [Tutorial on R, RStudio and R Markdown](https://ismayc.github.io/rbasics-book/)  
  - [Handy R cheatsheets](https://www.rstudio.com/resources/cheatsheets/)  
  - [R Notebooks tutorial](https://bookdown.org/yihui/rmarkdown/)  

## Set Up

We saved these results to a tab separated values (TSV) file called `gene_results_GSE44971.tsv`.
Its been saved to the `data` folder.  
File paths are relative to where this notebook file (.Rmd) is saved.
We saved our results file to a folder called `data`. 
So we can reference it later, let's make a object in our environment with our 
data directory name. 

```{r}
data_dir <- "data"
```

Magrittr pipe

```{r}
`%>%` <- dplyr::`%>%`
```

Let's declare our output folder name as its own object. 

```{r}
plots_dir <- "plots"
```

We can also create a directory if it doesn't already exist. 

```{r}
if(!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

## Read in the differential expression analysis results file

Here we are using a function `read_tsv` from a library of functions called `readr`. 

```{r}
stats_df <- readr::read_tsv(file.path(data_dir, 
                                      "gene_results_GSE44971.tsv"))
```

Let's take a look at what this data.frame looks like: 

```{r}
stats_df
```

We can take a look at a column individually by using a `$`. 

```{r}
stats_df$contrast
```

If we want to see less values at once, we can use brackets with the indices of the values we'd like returned.

```{r}
stats_df$avg_expression[1:10]
```

Let's checkout how many rows of data there are per each contrast.

```{r}
summary(as.factor(stats_df$contrast))
```

## Tidyverse brief intro 

Make a new variable of -log10 adjusted p values. 

```{r}
stats_df <- stats_df %>% 
  dplyr::mutate(neg_log_p_val = -log10(adj_p_value))
```

Let's filter to only `male_female` contrast data. 

```{r}
stats_df %>% 
  dplyr::filter(contrast == "male_female")
```

## Plotting this data

Let's make a volcano plot with this data. 

First let's take a look at only the tumor vs normal data. 

```{r}
stats_df %>% 
  dplyr::filter(contrast == "astrocytoma_normal") 
```

We can send this data.frame directly into a `ggplot` function. 

```{r}
stats_df %>% 
  dplyr::filter(contrast == "astrocytoma_normal") %>% 
ggplot2::ggplot(ggplot2::aes(x = log_fold_change, 
                             y = neg_log_p_val))
```

You'll notice this plot doesn't have anything on it because we haven't 
specified a plot type yet. 
To do that, we will add another ggplot layer with `+`. 

```{r}
stats_df %>% 
  dplyr::filter(contrast == "astrocytoma_normal") %>% 
ggplot2::ggplot(ggplot2::aes(x = log_fold_change, 
                             y = neg_log_p_val)) + 
  ggplot2::geom_point()
```

[ggplot2 structure](diagrams/ggplot_structure.png)

We can adjust the color points using `color`. 

```{r}
stats_df %>% 
  dplyr::filter(contrast == "astrocytoma_normal") %>% 
ggplot2::ggplot(ggplot2::aes(x = log_fold_change, 
                             y = neg_log_p_val, 
                             color = avg_expression)) + 
  ggplot2::geom_point()
```

We can also change the background and aesthetics by adding a `theme`.

```{r}
stats_df %>% 
  dplyr::filter(contrast == "astrocytoma_normal") %>% 
ggplot2::ggplot(ggplot2::aes(x = log_fold_change, 
                             y = neg_log_p_val, 
                             color = avg_expression)) + 
  ggplot2::geom_point() +
  ggplot2::theme_classic()
```

We can change the x and y labels by using `ylab` and `xlab` functions and add a
title using `ggplot2::ggtitle`.

```{r}
stats_df %>% 
  dplyr::filter(contrast == "astrocytoma_normal") %>% 
ggplot2::ggplot(ggplot2::aes(x = log_fold_change, 
                             y = neg_log_p_val, 
                             color = avg_expression)) + 
  ggplot2::geom_point() + 
  ggplot2::theme_classic() + 
  ggplot2::xlab("log10 Fold Change") +
  ggplot2::ylab("-log10 Adjusted p value")
  ggplot2::ggtitle("Astrocytoma Tumor vs Normal Cerebellum")
```

We can add all the contrasts to the plot by getting rid of the filter step
and then add a `facet_wrap` to make each contrast its own plot. 

```{r}
stats_df %>% 
ggplot2::ggplot(ggplot2::aes(x = log_fold_change, 
                             y = neg_log_p_val, 
                             color = avg_expression)) + 
  ggplot2::geom_point() + 
  ggplot2::theme_classic() + 
  ggplot2::facet_wrap(~ contrast) + 
  ggplot2::xlab("log10 Fold Change") +
  ggplot2::ylab("-log10 Adjusted p value")
```

We can store the plot as an object. 
Here we will call it `volcano_plot`. 

```{r}
volcano_plot <- stats_df %>% 
ggplot2::ggplot(ggplot2::aes(x = log_fold_change, 
                             y = neg_log_p_val, 
                             color = avg_expression)) + 
  ggplot2::geom_point() + 
  ggplot2::theme_classic() + 
  ggplot2::facet_wrap(~ contrast) + 
  ggplot2::xlab("log10 Fold Change") +
  ggplot2::ylab("-log10 Adjusted p value")
```

When we are happy with our plot, we can save the plot using `ggsave`. 

```{r}
ggplot2::ggsave(plot = volcano_plot, 
                filename = file.path(plots_dir, "volcano_plot.png"))
```

We can notice that some of these values with low p values seem very high for very log fold change. 

## Apply some cutoffs. 

Lets take a look at filtering genes by their average expression. 
Genes that are detected at too low of levels cannot be trusted to be accurately measured for differential expression. 

Let's get a summary of average expression of this dataset. 

```{r}
summary(stats_df$avg_expression)
```

Filter out expression values that are lower than the 1st Quartile and re-make the plot.

```{r}
stats_df %>% 
  dplyr::filter(avg_expression > 0.1754) %>% 
ggplot2::ggplot(ggplot2::aes(x = log_fold_change, 
                             y = neg_log_p_val, 
                             color = avg_expression)) + 
  ggplot2::geom_point() + 
  ggplot2::theme_classic() + 
  ggplot2::facet_wrap(~ contrast) + 
  ggplot2::xlab("log10 Fold Change") +
  ggplot2::ylab("-log10 Adjusted p value")
```

When we are done with the notebook, we want to print out the packages we've been using here so
we can reproduce this if we need. 

```{r}
# Print out the versions and packages we are using in this session
sessionInfo()
```
