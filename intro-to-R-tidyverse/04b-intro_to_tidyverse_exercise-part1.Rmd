---
title: "Introduction to Tidyverse - Exercises Part 2"
author: "Candace Savonen"
date: "2020"
output:
  html_notebook:
    toc: true
    toc_float: true
---

The goal of these exercises is to practice the visualization techniques and 
data frame manipulations we used in [02-intro_to_ggplot2](./01-intro_to_ggplot2.Rmd) 
and [03-intro_to_tidyverse](./01-intro_to_tidyverse.Rmd) notebooks. 

Here will use another [microrarray dataset](https://www.refine.bio/experiments/GSE19578/integrated-molecular-genetic-profiling-of-pediatric-high-grade-gliomas-reveals-key-differences-with-adult-disease) that is [pre-processed for us by refine.bio](http://docs.refine.bio/en/latest/main_text.html#processing-information).
This study from [Paugh et al, 2010](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2903336/) has glioblastoma samples from a range of patient ages. 

### Set Up 

In this notebook, we will not be loading functions using `library()` instead we 
will practice using functions with `::`. 

```{r}
# This handy assignment bit we use a lot so we can use the pipe, `%>%` all we 
# want without having to say `dplyr::` everytime. 
`%>%` <- dplyr::`%>%`
```

It's convenient to declare our directory names at the beginning so we can change
it once and have it change throughout the notebook. 

```{r}
input_dir <- 
output_dir <- 
```

## Read in the gene results file

Use `readr::read_tsv` to read in the gene expression matrix TSV, "GSE19578.tsv" 
and assign it the name `genes_df`. 

```{r}

```

Use this chunk to explore what your data frame, `genes_df` looks like. 

```{r}

```

## Read in the metadata

Use the same function to read in the file "metadata_GSE19578.tsv" and assign 
it the name `metadata`. 

```{r}

```

Use this chunk to explore what your data frame, `metadata` looks like. 

```{r}

```

## Cleaning the metadata

As is common with metadata, we will need to do some cleaning. 
Although GEO gives us a lot of information, a lot of these fields are not informative for us at this stage. 

**Step 1 of cleaning**: keep only informative columns. 

Use `dplyr::select` to keep the 3 columns with the following information: 
+ The sample accession codes
+ age as a numeric variable
+ disease information

Assign the `select`ed metadata as `metadata_clean`. 

```{r}

```

Look up details on `select` and figure out how we can (in the same step!) 
rename these columns to be shorter and more to the point like `sample_id`, 
`age` and `disease` for example. 

```{r}

```

**Step 2 of cleaning**: format variables to the type they should be.

Currently, our `disease` variable has repeated values, but using `summary` 
wouldn't show us that. 
Try it out by subsetting the `disease` column. 

```{r}

```

To avoid handling issues of this variable, let's try to coerce it to a `factor`
using `dplyr::mutate`. 
We'll need to use `metadata_clean` and reassign it the same name. 

```{r}

```

Use `summary` on the re-factored `disease` column to see how many samples of each
there are. 

```{r}

```

**Step 3 of cleaning**: Create new grouping variables. 

Using the age variable, let's create a new grouping variable that indicates a 
`TRUE/FALSE` of whether the patient is above `18`. 

```{r}

```

**Step 4 of cleaning**: Arrange metdata in a sensible order

Use `dplyr::arrange` to arrange the rows from youngest to oldest `age`. 

```{r}

```

**Step 5 of cleaning**: Write the cleaned metadata to TSV

Now that we've cleaned our metadata, let's save it to a file using 
`readr::write_tsv`.

```{r}

```

Now that we've determined all the steps that need to be taken to clean our data, 
we can assemble these steps into one set of piped (`%>%`) transformations. 
Assemble steps 1-5 into one set where each step pipes (`%>%`) into the next. 
You should also make sure to have comments (`#`) on each step so we know why we
are doing it when we look back at this later!

```{r}

```

## Set up gene data

#### Order sample data

Commonly, the sample order for our metdata and gene expression matrix will not 
automatically match. 
This should be the first thing we check before we try to use them in tandem. 

Use `all.equal()` to see if the sample ids of columns of `gene_df` are in the 
same order as our `sample_id` column in `metadata_clean`. 
Hint: you will want to ignore the `Gene` column when checking this, try a negative 
index

```{r}

```

Before we reorder our samples, we should also check if all the samples list in 
`metadata_clean` also exist in `gene_df`. 
Use `all()` and `%>%` to write a logical expression to check this.

```{r}

```

Now let's use `dplyr::select` to reorder the columns in `gene_df` to the order 
of `sample_id`s in `metadata_clean`. 
Hint: Don't forget about accounting for the `Gene` column! 

```{r}

```

Re-test the order of the samples the same way you did before, using `all.equal()`

```{r}

```

#### Filter out low value genes

For microarray data, lower expression value genes may be an indication of 
unreliable measurement.

Let's calculate the average expression per gene using `apply()`. 
Don't forget to move `Gene` column out of the way. 
Store this vector as `gene_means`. 

```{r}

```

Use `summary` to get a overall view of the `gene_means` distribution. 

```{r}

```

We've set up a `ggplot2::qplot` to take a look at the `gene_mean` distribution.
`ggplot2::qplot` allows you to set up a vector as a `ggplot`. 
Add on layers with `+` to customize it. 
Have one of those layers be a `geom_vline()` that notes where you are making 
a minimum average expression cutoff. 

```{r}
density_plot <- ggplot2::qplot(gene_means, geom = "density") + 
  # Add geom_density
  ggplot2::geom_density(fill = "lightgreen") 
  # Add on layers with `+` to customize this plot
```

Print a preview of the plot. 

```{r}
density_plot
```

Apply the filter cutoff to `genes_df`. 
Use `dplyr::filter` to filter out the low expression genes based on your chosen 
cutoff. 
We'll call this newly filtered data frame `filtered_genes_df`. 

```{r}
filtered_genes_df <- 
```

## Set up grouped summary statistics for genes

Let's calculate some fold changes for our groups. 
We've set up a data frame that is transposed so you can use using `tidyverse` functions. 

```{r}
transposed_genes_df <- filtered_genes_df %>% 
  # We want the gene information to be stored as rownames for the next set of 
  # steps we are doing
  tibble::column_to_rownames("Gene") %>% 
  # Transposing the data frame so it is sample x genes
  t() %>% 
  # t() function turns our data frame into a matrix so let's turn it back to 
  # a data.frame so we can use it with tidyverse functions
  as.data.frame() %>% 
  # By default our sample ids will be stored as rownames, let's bring it out as 
  # its own columns 
  tibble::rownames_to_column("sample_id")
```

Use `dplyr::select()` and an `%in%` statement to choose ~2-5 genes of interest. 
Can use [GeneCard](https://www.genecards.org/) to find the corresponding Ensembl
ID to your favorite genes. 

```{r}

```

Use `dplyr::inner_join()` to join the `metadata_clean` columns to 
`transposed_genes_df` by the `sample_id`. 

```{r}

```

Calculate the group means of your `select`ed genes. 

```{r}

```

### Plot the data

Now that we have our data set up, we will make some plots!

**Plot 1) Scatterplot**

Set up a ggplot scatterplot with either one or two of the selected genes in
`genes_of_interest_df` and/or with `age`. 
(Remember we didn't load the `ggplot2` library, so you'll need to use `::` to 
reference it at each step).

```{r} 

```

**Plot 2) Facet wrapped jitter**

Create a jitter plot of each gene where each `disease` group has its own plot 
using `facet_wrap`. 

We've done the first step for you. 
Your data will need to be in a long format. 
Explore the `long_form_genes_oi_df` data frame to see how we've transformed it 
with `tidyr::gather`. 

```{r}
# Reformat to long format data frame 
long_form_genes_oi_df <- genes_of_interest_df %>% 
  tidyr::gather(gene, expression_value, -sample_id, -age, -disease, -adult)

# Print preview
long_form_genes_oi_df 
```

Make a `facet_wrap`ped plot of the genes' expression levels. 

```{r}

```

Make other customizations to this plot by adding more layers with `+` or change 
the plot completely to something else!

**ggplot2 resources to get you going:**  
- [Top 50 ggplots](http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html)
+ [handy cheatsheet for ggplot2](https://rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf)  
+ [ggplot2 courses and books from Tidyverse](https://ggplot2.tidyverse.org/)  
+ [ggplot2 data viz chapter of R for Data Science](https://r4ds.had.co.nz/data-visualisation.html)  
+ [ggplot2 online tutorial](http://r-statistics.co/Complete-Ggplot2-Tutorial-Part1-With-R-Code.html)  

```{r}
# Play with your plot and data!
# Ideas to get your juices flowing: 
# - Add a jitter layer over the boxplot
# - Play with the color of the points!
# - Use ggthemes to play with the aesthetics
# - facet_wrap by another variable
```

When you are happy with your plot, save your plot as a `PNG` using `ggplot2::ggsave()`.

```{r}

```

### Session Info

```{r}
sessionInfo()
```

