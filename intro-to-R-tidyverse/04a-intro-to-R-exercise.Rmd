---
title: "Introduction to R - Exercises"
author: "Candace Savonen"
date: "2020"
output:
  html_notebook:
    toc: true
    toc_float: true
---

## Objectives
+ Load tidyverse
+ Read in gene results data frame 
+ Practice subsetting data frame and exploring data structure
+ Understand and use simple R functions 
+ Create a ggplot
+ Export and save figures
+ Save data frame to TSV

### Set Up 

Use this chunk to load the `tidyverse` library. 

```{r}
library(tidyverse)
```

## Read in the gene results file

Use `readr::read_tsv` to read in the file "gene_results_GSE44971.tsv" and assign 
it the name `stats_df`. 

```{r}
stats_df <- readr::read_tsv(file.path("data", "gene_results_GSE44971.tsv"))
```

Use this chunk to explore what your data frame, `stats_df` looks like. 

```{r}
head(stats_df)
```

## Read in the metadata

Use `readr::read_tsv` to read in the file "cleaned_metadata_GSE44971.tsv" and assign 
it the name `metadata`. 

```{r}
metadata <- readr::read_tsv(file.path("data", "cleaned_metadata_GSE44971.tsv"))
```

Use this chunk to explore what your data frame, `metadata` looks like. 

```{r}
str(metadata)
```

### Subsetting variables

Use subsetting to take a look at the `avg_expression` column. 

```{r}
stats_df$avg_expression
```

Use the `min()` argument to find what the minimum average expression in this dataset is. 
Remember you can use `?min` or the help panel to find out more about a function. 

```{r}
# Find the minimum average expression value
min(stats_df$avg_expression)
```

Find the `log`, using base 2, of the average expression values. 

```{r}
# Find the log of base 2 of the average expression
log2(stats_df$avg_expression)
```

## Using logical arguments

Use subsetting to take a look at the `adj_p_value` column. 

```{r}
stats_df$adj_p_value
```

Find out which p-values in total are below a `0.05` cutoff using a logical 
statement. 

```{r}
stats_df$adj_p_value < 0.05
```

Store the logical vector you created above as `significant_vector`.

```{r}
significant_vector <- stats_df$adj_p_value < 0.05

significant_vector
```

Use `sum` to count how many p values in the total set are below this cutoff. 

```{r}
sum(significant_vector)
```

## Filter the dataset

Subset the column `contrasts` from `stats_df`. 

```{r}
stats_df$contrast
```

Construct a logical vector around the contrasts variable you subset above that 
indicates which rows of data in `stats_df` are from the `astrocytoma_normal` 
contrast test. 

```{r}
stats_df$contrast == "astrocytoma_normal"
```

Use `dplyr::filter` to keep only the data for the `astrocytoma_normal` contrast
in `stats_df`. 

```{r}
astrocytoma_normal_df <- dplyr::filter(stats_df, contrast == "astrocytoma_normal")
```

Use the `nrow` argument on `astrocytoma_normal_df` to see if your filter worked. 
You should have `2268` rows. 

```{r}
nrow(astrocytoma_normal_df)
```

Do the same filtering as you did above, but this time, use a `%>%` by removing 
`stats_df` from the first argument position and piping it into the filter. 

```{r}
astrocytoma_normal_df <- stats_df %>% 
  dplyr::filter(contrast == "astrocytoma_normal")
```

Save your filtered data to a TSV file using `readr::write_tsv`. 
Call it `astrocytoma_normal_contrast_results.tsv` and save it to the `results`
directory. 

```{r}
readr::write_tsv(astrocytoma_normal_df,
                 file.path("results", "astrocytoma_normal_contrast_results.tsv"))
```


### Create a density plot 

Set up a ggplot object for `astrocytoma_normal_df` and set `x` as the average 
expression variable. 
Use the `+` to add on a layer called `geom_density()`

```{r}
ggplot(astrocytoma_normal_df, aes(x = avg_expression)) + 
  geom_density()
```

Use the plot you started above and add a `ggtheme` layer to play with its aesthetics (e.g. `theme_classic()`)
See the [ggthemes vignette](https://mran.microsoft.com/snapshot/2017-02-04/web/packages/ggthemes/vignettes/ggthemes.html) 
to see a list of ggtheme options. 

```{r}
ggplot(astrocytoma_normal_df, aes(x = avg_expression)) + 
  geom_density() + 
  theme_minimal()
```

Feel free to make other customizations to this plot by adding more layers with `+`. 
You could add a `ylab()` and `xlab()` and/or by getting inspiration from this [handy cheatsheet for ggplot2](https://rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf). 

```{r}
# Customize your plot!
ggplot(astrocytoma_normal_df, aes(x = avg_expression)) + 
  geom_density(fill = "lightgreen") + 
  theme_minimal() + 
  xlab("Average Expression") +
  ylab("Density") + 
  ggtitle("Average Expression Density for Astrocytoma - Normal")
```

Save your plot as a `PNG`. 

```{r}
ggsave(
  plot = last_plot(), # This will retrieve the last plot you printed. 
  filename = file.path("plots", "average_expression_density_plot.png")
)
```

### Session Info

```{r}
sessionInfo()
```

