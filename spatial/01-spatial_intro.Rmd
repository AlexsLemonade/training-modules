---
title: "Importing, processing, and exploring Visium data"
author: Data Lab for ALSF
date: 2026
output:
  html_notebook:
    toc: true
    toc_float: true
---

## Objectives

- Read Visium data into R
- Filter to spots overlapping tissue
- Calculate quality control measures on spatial transcriptomic data
- Remove likely low-quality spots with `SpotSweeper()`
- Normalize spatial expression data
- Visualize spatial transcriptomic data 

## Introduction

In this notebook, we'll learn some basic import, processing, and visualization of a Visium data set, starting with the Space Ranger output. 

The data we'll use in this notebook is from an anaplastic Wilms Tumor sample in the [Single-cell Pediatric Cancer Atlas](https://scpca.alexslemonade.org/projects/SCPCP000006).
This sample was processed using first-generation 3' Visium technology, and it was quantified with `Space Ranger 1.3.1`.

## Set up

To begin, we'll load the core library for spatial transcriptomic objects in Bioconductor, `SpatialExperiment`.
We won't be doing any calculations involving random numbers here, so we don't need to set a seed.

```{r libraries}
# Load libraries

# The main class we use for spatial transcriptomic data
library(SpatialExperiment)
```

### Directories and files

Next we'll define paths and files.

```{r inputs, live=TRUE}
# main data directory 
data_dir <- file.path("data/wilms-tumor/SCPCS000190")

# Path to Space Ranger output
raw_spaceranger_dir <- file.path(data_dir, "outs")

# reference data directory
ref_dir <- file.path("data/reference")

# Path to mitochondrial genes table
mito_file <- file.path(ref_dir, "hs_mitochondrial_genes.tsv")
```


```{r outputs}
# Directory and file to save output
normalized_dir <- file.path(data_dir, "normalized")

# create the directory if it does not exist
fs::dir_create(normalized_dir)

# output RDS file for normalized Spatial Experiment (SPE) object
output_spe_file <- file.path(
  normalized_dir,
  "SCPCS000190_normalized.rds"
)
```



## Reading Space Ranger data

We'll use the `VisiumIO` package to read this data in.
The directory structure typically looks something like this, with differences for different technology versions.

```markdown
_add file tree here with standard visium output_
```

Let's see what we have:

```{r dir-spaceranger, live = TRUE}
dir(raw_spaceranger_dir)
```

The filtered/raw matrix directories are analogous to we'd get from `Cell Ranger` for single-cell sequencing, but the `spatial` directory contains spatial information, including images, that augment the data with its full spatial context.
Without this directory, we could still read in the filtered/raw and make an `SCE`, but you wouldn't have the spatial info.

Along those lines, let's have a closer look at what's in the `spatial` directory:

```{r dir-spatial, live = TRUE}
dir(
  file.path(raw_spaceranger_dir, "spatial")
)
```

Placeholder to describe each image file:

- `"aligned_fiducials.jpg"`
- `"detected_tissue_image.jpg"` 
- `"tissue_hires_image.png"` 
- `"tissue_lowres_image.png"`
- `"tissue_positions_list.csv"`
- `"scalefactors_json.json"`   

It's worth mentioning that this is a slightly older technology than the current Visium `CytAssist` image, which means there is no specific `Cytassist` image.
This won't affect our analysis, but worth noting when reading in since by default the functions assume that image is present. 


We'll import the raw, not filtered, version of the data here so that we can see full processing steps and save it to a variable called `spe`, using the package `VisiumIO`.

```{r import-visium, live = TRUE}
# path to quantified RNA 10X output
rna_dir <- file.path(raw_spaceranger_dir, "raw_feature_bc_matrix")

# path to spatial 10X output
spatial_dir <- file.path(raw_spaceranger_dir, "spatial")

spe <- VisiumIO::import(
  VisiumIO::TENxVisium(
    # path that contains the sequencing data
    resources = rna_dir,
    # path that contains the spatial data
    spatialResource = spatial_dir,
    # which image(s) to import - use lowres to save some memory/space
    # we also need to override the default since it assumes there is a CytAssist image
    images = "lowres"
  )
)

# print the spe
spe
```

Let's get to know our `SPE` object!
It's essentially an `SCE`, but with a few more bells and whistles.
This means there are some functions we'll use to explore it that you might recognize, but there will also be some new ones only used for `SPE` objects.

First, note that we have 4992 spots - this is not a random value.
It's the number of spots on a Visium 6.5 x 6.5 slide. 

Like `SCE`s, we have slots like `assays` for count matrices, `rowData` for feature metadata, and `colData` for _spot_ metadata - recall, our experimental units are not individual cells in spatial transcriptomics.
Let's take a tour:

```{r spe-rowdata}
rowData(spe)
```

```{r spe-assays}
counts(spe)[1:10, 1:10]
```
Again, for the colData`, we're looking at spots and not cells.
With this technology where each spot is 55 `um`, we can expect there's somewhere between 1-10 cells per spot.

```{r spe-coldata, live = TRUE}
colData(spe)
```
Check out that `in_tissue` column.
It contains 0/1 because we read in the raw `Space Ranger` output, which includes all spots including those which don't actually overlap tissue.
Ultimately, we won't want to analyze the spots that are not on top of tissue, so we'll have to deal with that.

Unlike `SCE`s, we have spatial information in a dedicated `spatialCoords` slot which contains the x/y coordinates on the slide:
```{r spe-spatialcoords, live = TRUE}
# handy function from our code package SpatialExperiment
# literally is giving x/y coordinates
spatialCoords(spe) |> head()
```

We also have a slot that just holds the images, `imgData`, although looking at it directly isn't very interesting.
But, this stored information will help us make figures!

```{r spe-imgdata, live = TRUE}
imgData(spe)
```

### Introduction to spatial data visualization

Before we get further, let's go ahead and actually look at our data.
Because the spatial and image information is contained in the object, we can plot directly from this object using the viz package `ggspavis`.


```{r plot-visium, live = TRUE}
ggspavis::plotVisium(spe)
```

Here, we see the spots overlaid on the slide as well as slide boundaries.
You'll notice that every single spot is shown, including ones that don't overlap tissue directly - indeed, all 4992 spots are present int he `SPE` right now!

By default this shows the spots, but we can hide them and zoom into the tissue on the slide.
This is a helpful way to pop up the H&E for side-by-side comparisons with other plots you might make.

```{r plot-visium-zoom, live = TRUE}
ggspavis::plotVisium(
  spe, 
  spots = FALSE, # don't show the spots
  zoom = TRUE    # zoom into the slide area
) 
```

TODO: save this text for when we actually plot genes?
Let's take a moment to chat about Wilms Tumor - these tumors in the developing kidney are often composed of a couple histologic compartments, blastemal, stromal (with mesenchymal biology), and sometimes epithelial components.
In this tissue section, we can see two major components: the bluer indicating densely cellular, ECM-poor regions consistent with blastema, and paler pink regions consistent with stromal tissue.


There's another function in `ggspavis` called `plotCoords` which hides the H&E to just show the spots; this plot is not currently very compelling without any colors, but we'll add those soon!

```{r plot-coords, live = TRUE}
# plot just the spots
ggspavis::plotCoords(spe) 
```

The spot layout looks a bit different.
By default, this function will only plot spots that overlay tissue, even if those spots are still in the `SPE`.

We can override this if we want, but really what we want to do is actually remove those spots since they are entirely uninformative - we'll do this in the next section.


## Filtering empty spots

## Filtering low-quality spots

## Normalization

## Exploring marker gene expression


## Session info

To conclude, we'll run the `sessionInfo()` command to print out exactly what system setting and R package versions were used to run this code.

```{r}
sessionInfo()
```

